<style>
    .print-format {
        font-size: 8pt !important;
        margin-top: 6mm !important;
        margin-left: 8mm !important;
        margin-right: 6mm !important;
        margin-bottom: 6mm !important;
    }

    .print-format td {
        vertical-align: middle !important;
    }

    .fade_rule {
        height: 1px;
        background-color: #e6e6e6;
        width: 25em;
        margin: 20 auto;
        background-image: linear-gradient(left, white 12%, #e6e6e6 100%, white 98%);
        background-image: -o-linear-gradient(left, white 12%, #e6e6e6 100%, white 98%);
        background-image: -moz-linear-gradient(left, white 12%, #e6e6e6 100%, white 98%);
        background-image: -webkit-linear-gradient(left, white 12%, #e6e6e6 100%, white 98%);
        background-image: -ms-linear-gradient(left, white 12%, #e6e6e6 100%, white 98%);
        background-image: -webkit-gradient(linear, left bottom, right bottom, color-stop(1, white), color-stop(0.5, gray), color-stop(0.98, white));
    }

    .clearbackground {
        margin: 0px auto 0px auto;
        /* keep the table centered */
        padding: 1px;
        border: 1px solid #9b9b9b;
        font-weight: 700;
        background-color: white;
    }
    
    td {
        font-size: 10pt !important;
    }
    td {
        height: 1.2em !important;
        padding-top: 0.1em !important;
        padding-bottom: 0.1em !important;
    }
    .clearfix::after {
        content: "";
        clear: both;
        display: table;
    }
    
</style>
<!-- ACCOUNTS RECEIVABLE -->
    {% if letter_head.content %}
    <div class="clearfix" style="padding: 2px; border-radius: 5px;">
        {{ letter_head.content }}
    {% else %}
        <div class="clearfix" style="padding: 2px; background-color: #f1f1f1; border-radius: 5px;">
        <div style="margin-left:15px; margin-top:10px; float:left;">
            <img src="{{ frappe.db.get_single_value('website Settings', 'app_logo') or '' }}" alt=""
                style="height: 80px; float:left; max-width: 200px;" />
        </div>
        <div style="margin-right:15px; margin-top:5px; text-align: right; float: right;">
            <h1 style="font-weight: 900 !important;vertical-align: top;">{{ filters.company|upper }}</h1>
            <h5>
                <p>For: <span class="clearbackground">{{ filters.customer_name }}</span></p>
                    <p>{% if (filters.tax_id) %} {{ _("Tax Id: ") }}{{ filters.tax_id }} {% endif %} {{
                        _(filters.ageing_based_on) }} {{ _("Until") }} <span class="clearbackground">{{
                            frappe.format(filters.report_date, 'Date') }}</span></p>
            </h5>
        </div>
    {% endif %}
    <div class="clearfix">
        <span>
            <h5 style="float:right; text-align: right;">
                
            </h5>
        </span>
    
        <div class="pull-left">
            {% if(filters.payment_terms) %}
                <strong>{{ _("Payment Terms") }}:</strong> {{ filters.payment_terms }} 
            {% endif %}
        </div>
        <div class="pull-right">
            {% if(filters.credit_limit) %}
                <strong>{{ _("Credit Limit") }}:</strong> {{ frappe.utils.fmt_money(filters.credit_limit) }}
            {% endif %}
        </div>
    </div>
    {% if(filters.show_future_payments) %} {% set balance_row = data.slice(-1).pop() %} {% for i in report.columns %} {%
    if i.fieldname == 'age' %} {% set elem = i %} {% endif %} {% endfor %} {% set start = report.columns.findIndex(elem)
    %} {%
    set range1 = report.columns[start].label %} {% set range2 = report.columns[start+1].label %} {% set range3 =
    report.columns[start+2].label %} {% set range4 = report.columns[start+3].label %} {% set range5 =
    report.columns[start+4].label %}
    {% set range6 = report.columns[start+5].label %} {% if(balance_row) %}
    <table class="table" style="padding: 0px; margin: 0px;">
        <caption class="text-right">
            (Amount in {{ data[0]["currency"] ~ "" }})
        </caption>
        <colgroup>
            <col style="width: 30mm;" />
            <col style="width: 18mm;" />
            <col style="width: 18mm;" />
            <col style="width: 18mm;" />
            <col style="width: 18mm;" />
            <col style="width: 18mm;" />
            <col style="width: 18mm;" />
            <col style="width: 18mm;" />
        </colgroup>
        <thead>
            <tr>
                <th>{{ _(" ") }}</th>
                <th>{{ _(range1) }}</th>
                <th>{{ _(range2) }}</th>
                <th>{{ _(range3) }}</th>
                <th>{{ _(range4) }}</th>
                <th>{{ _(range5) }}</th>
                <th>{{ _(range6) }}</th>
                <th>{{ _("Total") }}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ _("Total Outstanding") }}</td>
                <td class="text-right">
                    {{ format_number(balance_row["age"], null, 2) }}
                </td>
                <td class="text-right">
                    {{ frappe.utils.fmt_money(balance_row["range1"], data[data.length-1]["currency"]) }}
                </td>
                <td class="text-right">
                    {{ frappe.utils.fmt_money(balance_row["range2"], data[data.length-1]["currency"]) }}
                </td>
                <td class="text-right">
                    {{ frappe.utils.fmt_money(balance_row["range3"], data[data.length-1]["currency"]) }}
                </td>
                <td class="text-right">
                    {{ frappe.utils.fmt_money(balance_row["range4"], data[data.length-1]["currency"]) }}
                </td>
                <td class="text-right">
                    {{ frappe.utils.fmt_money(balance_row["range5"], data[data.length-1]["currency"]) }}
                </td>
                <td class="text-right">
                    {{ frappe.utils.fmt_money(flt(balance_row["outstanding"]), data[data.length-1]["currency"]) }}
                </td>
            </tr>
            <td>{{ _("Future Payments") }}</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td class="text-right">
                {{ frappe.utils.fmt_money(flt(balance_row[("future_amount")]), data[data.length-1]["currency"]) }}
            </td>
            <tr class="cvs-footer">
                <th class="text-left">{{ _("Cheques Required") }}</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th class="text-right">
                    {{ frappe.utils.fmt_money(flt(balance_row["outstanding"] - balance_row[("future_amount")]),
                    data[data.length-1]["currency"]) }}
                </th>
            </tr>
        </tbody>
    </table>
    {% endif %} {% endif %}

    <span style="float: left;">
        <h4
            style="letter-spacing: 1px; text-transform: capitalize; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">
            {{ report.report_name|upper }}
            <div class="fade_rule"></div>
        </h4>
    </span>
    <table class="table">
        <thead>
            <tr>
                {% if(report.report_name == "Accounts Receivable" or report.report_name == "Accounts Payable") %}
                <th style="width: 8%;">{{ _("Date") }}</th>
                <th style="width: 2%; text-align: left;">{{ _("Days") }}</th>
                {% if(report.report_name == "Accounts Receivable" and filters.show_sales_person) %}
                <th style="width: 8%;">{{ _("Type") }}</th>
                <th style="width: 12%;">{{ _("Reference") }}</th>
                <th style="width: 10%;">{{ _("Sales Person") }}</th>
                {% else %}
                <th style="width: 8%;">{{ _("Type") }}</th>
                <th style="width: 12%;">{{ _("Reference") }}</th>
                {% endif %} {% if not(filters.show_future_payments) %}
                {% if filters.show_remarks %}
                <th style="width: 20%;">
                    {% if (filters.customer or filters.supplier or filters.customer_name) %} {{ _("Remarks") }} {% else
                    %} {{ _("Party") }} {% endif %}
                </th>
                {% endif %}
                {% endif %}
                <th style="width: 8%; text-align: right;">{{ _("Invoiced Amount") }}</th>
                {% if not(filters.show_future_payments) %}
                <th style="width: 8%; text-align: right;">{{ _("Paid Amount") }}</th>
                <th style="width: 8%; text-align: right;">
                    {% if report.report_name == "Accounts Receivable" %} {{ _('Credited Amount') }} {% else %} {{ _('Debited Amount') }} {% endif %}
                </th>
                {% endif %}
                <th style="width: 8%; text-align: right;">{{ _("Outstanding") }}</th>
                {% if(filters.show_future_payments) %} {% if(report.report_name == "Accounts Receivable") %}
                <th style="width: 8%;">{{ _("Customer LPO No.") }}</th>
                {% endif %}
                <th style="width: 8%;">{{ _("Future Payment Ref") }}</th>
                <th style="width: 8%;">{{ _("Future Payment Amount") }}</th>
                <th style="width: 8%;">{{ _("Remaining Balance") }}</th>
                {% endif %} {% else %}
                <th style="width: 30%;">
                    {% if (filters.customer or filters.supplier or filters.customer_name) %} {{ _("Remarks")}} {% else
                    %} {{ _("Party") }} {% endif %}
                </th>
                <th style="width: 10%;">{{ _("Total Invoiced Amount") }}</th>
                <th style="width: 10%;">{{ _("Total Paid Amount") }}</th>
                <th style="width: 10%;">
                    {% if report.report_name == "Accounts Receivable Summary" %} {{ _('Credit Note Amount') }} {% else
                    %} {{ _('Debit Note Amount') }} {% endif %}
                </th>
                <th style="width: 12%;">{{ _("Total Outstanding Amount") }}</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for i in range(data|length) %}
            <tr>
                {% if(report.report_name == "Accounts Receivable" or report.report_name == "Accounts Payable") %} {%
                if(data[i]["party"]) %}
                <td>{{ (data[i]["posting_date"]) }}</td>
                <td style="text-align: left;">{{ data[i]["age"] }}</td>
                <td>{{ data[i]["voucher_type"] }}</td>
                <td>{{ data[i]["voucher_no"] }}</td>
                {% if(report.report_name == "Accounts Receivable" and filters.show_sales_person) %}
                <td>{{ data[i]["sales_person"] }}</td>
                {% endif %} {% if not (filters.show_future_payments) %}
                {% if filters.show_remarks %}
                <td>
                    {% if(data[i]["voucher_type"] == "Sales Invoice") %}    <!-- Only check if Sales Invoice + Returns - For Kenyan TIMS Integration -->
                        {% set cuin, cuurl = frappe.db.get_value('Sales Invoice', data[i]["voucher_no"], ['etr_invoice_number', 'cu_link']) %}
                        {% if cuin and cuurl %}
                        CUIN: <a href={{ cuurl }} target="_blank">{{ cuin }}</a>
                        {% endif %} 
                    {% endif %}
                    {% if(not(filters.customer or filters.supplier or filters.customer_name)) %} {{ data[i]["party"] }}
                    {% if(data[i]["customer_name"] and data[i]["customer_name"] != data[i]["party"]) %}
                    <br />
                    {{ data[i]["customer_name"] }} {% elif(data[i]["supplier_name"] != data[i]["party"]) %} <br />
                    {{ data[i]["supplier_name"] }} {% endif %} {% endif %}
                    <div>
                        {% if data[i]["remarks"] %} {{ data[i]["remarks"]|replace('No Remarks','') }} {% endif %}
                    </div>
                </td>
                {% endif %}
                {% endif %}
                <td style="text-align: right;">
                    <!-- {{ frappe.utils.fmt_money(data[i]["invoiced"], currency=data[i]["currency"]) }} -->
                    {{ frappe.utils.fmt_money(data[i]["invoiced"]) }}
                </td>
                {% if not(filters.show_future_payments) %}
                <td style="text-align: right;">
                    {{ frappe.utils.fmt_money(data[i]["paid"]) }}
                </td>
                <td style="text-align: right;">
                    {{ frappe.utils.fmt_money(data[i]["credit_note"]) }}
                </td>
                {% endif %}
                <td style="text-align: right;">
                    {{ frappe.utils.fmt_money(data[i]["outstanding"]) }}
                </td>
                {% if(filters.show_future_payments) %} {% if(report.report_name == "Accounts Receivable") %}
                <td style="text-align: right;">
                    {{ data[i]["po_no"] }}
                </td>
                {% endif %}
                <td style="text-align: right;">{{ data[i]["future_ref"] }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["future_amount"]) }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["remaining_balance"]) }}</td>
                {% endif %} {% else %}
                <td></td>
                {% if not(filters.show_future_payments) %}
                <td></td>
                {% endif %} {% if(report.report_name == "Accounts Receivable" and filters.show_sales_person) %}
                <td></td>
                {% endif %}
                <td></td>
                <td style="text-align: right;"><b>{{ _("Total") }}</b></td>
                <td style="text-align: right;">
                    {{ frappe.utils.fmt_money(data[i]["invoiced"], data[i]["currency"]) }}
                </td>
                {% if not(filters.show_future_payments) %}
                <td style="text-align: right;">
                    {{ frappe.utils.fmt_money(data[i]["paid"], currency=data[i]["currency"]) }}
                </td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["credit_note"],
                    currency=data[i]["currency"]) }}</td>
                {% endif %}
                <td style="text-align: right;">
                    {{ frappe.utils.fmt_money(data[i]["outstanding"], currency=data[i]["currency"]) }}
                </td>
                {% if(filters.show_future_payments) %} {% if(report.report_name == "Accounts Receivable") %}
                <td style="text-align: right;">
                    {{ data[i]["po_no"] }}
                </td>
                {% endif %}
                <td style="text-align: right;">{{ data[i]["future_ref"] }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["future_amount"],
                    currency=data[i]["currency"]) }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["remaining_balance"],
                    currency=data[i]["currency"]) }}</td>
                {% endif %} {% endif %} {% else %} {% if(data[i]["party"] or "&nbsp;") %} {% if
                not(data[i]["is_total_row"]) %}
                <td>
                    {% if(not(filters.customer | filters.supplier)) %} {{ data[i]["party"] }} {%
                    if(data[i]["customer_name"] and data[i]["customer_name"] != data[i]["party"]) %}
                    <br />
                    {{ data[i]["customer_name"] }} {% elif(data[i]["supplier_name"] != data[i]["party"]) %} <br />
                    {{ data[i]["supplier_name"] }} {% endif %} {% endif %} <br />
                    {{ _("Remarks") }}: {{ data[i]["remarks"] }}
                </td>
                {% else %}
                <td><b>{{ _("Total") }}</b></td>
                {% endif %}
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["invoiced"],currency=data[i]["currency"]) }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["paid"], currency=data[i]["currency"]) }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["credit_note"], currency=data[i]["currency"]) }}</td>
                <td style="text-align: right;">{{ frappe.utils.fmt_money(data[i]["outstanding"], currency=data[i]["currency"]) }}</td>
                {% endif %} {% endif %}
            </tr>
            {% endfor %}
            <!-- TABLE SUMMARY -->
            <td></td>
            <td></td>
            <td></td>
            {% if filters.show_remarks %}<td></td>{% else %}<td style="text-align: right;">{{ data[0]["currency"] }}</td>{% endif %}
            {% if filters.show_remarks %}<td style="text-align: right;">{{ data[0]["currency"] }}</td>{% endif %}
            <td style="text-align: right;"><b>{{ frappe.utils.fmt_money(data|sum(attribute="invoiced")) }}</b></td>
            <td style="text-align: right;"><b>{{ frappe.utils.fmt_money(data|sum(attribute="paid")) }}</b></td>
            <td style="text-align: right;"><b>{{ frappe.utils.fmt_money(data|sum(attribute="credit_note")) }}</b></td>
            <td style="text-align: right;"><b>{{ frappe.utils.fmt_money(data|sum(attribute="outstanding")) }}</b></td>
        </tbody>
    </table>
    
    {% if ageing %}
    <h4
        style="letter-spacing: 1px; text-transform: capitalize; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;">
        AGING SUMMARY
        <div class="fade_rule"></div>
    </h4>
    <table class="table" style="font-size: 12px; padding: 0px; margin: 0px;">
        <thead>
            <tr>
                <th style="width: 35%;">{{ _("Aging") }}</th>
                <th style="width: 13%;">0 - 30 Days</th>
                <th style="width: 13%;">30 - 60 Days</th>
                <th style="width: 13%;">60 - 90 Days</th>
                <th style="width: 13%;">90 - 120 Days</th>
                <th style="width: 13%;">120+ Days</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{ _("Based on ") }} {{ ageing.ageing_based_on }} {{ _("up to " ) }} {{
                    frappe.format(filters.report_date, 'Date')}}</td>
                <td>{{ frappe.utils.fmt_money(ageing.range1, currency=data[0]["currency"]) }}</td>
                <td>{{ frappe.utils.fmt_money(ageing.range2, currency=data[0]["currency"]) }}</td>
                <td>{{ frappe.utils.fmt_money(ageing.range3, currency=data[0]["currency"]) }}</td>
                <td>{{ frappe.utils.fmt_money(ageing.range4, currency=data[0]["currency"]) }}</td>
                <td>{{ frappe.utils.fmt_money(ageing.range5, currency=filters.presentation_currency) }}</td>
            </tr>
        </tbody>
    </table>
    {% endif %}

    {% if terms_and_conditions %}
    <div style="width: 50%; float: left;">
        <h4
            style="letter-spacing: 1px; text-transform: capitalize; font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif">
            TERMS<div class="fade_rule"></div>
        </h4>
        <div style="font-size:10px !important;">
            <p>{{ terms_and_conditions }}</p>
        </div>
    </div>
    {% endif %}
    <div style="width: 40%; float: right;">
        {% set pdc = frappe.db.get_list('Payment Entry', filters={'reference_date': ['>', frappe.utils.nowdate()],'party': ['=', filters.party[0]]}, 
                                        fields=['posting_date', 'mode_of_payment', 'reference_date', 'paid_amount', 'status']) %}
        {% if pdc %}
        <h4 style="letter-spacing: 1px; text-transform: capitalize; font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif">
            FUTURE PAYMENTS<div class="fade_rule"></div>
        </h4>
        <table class="" style="font-size: 11px; padding: 0px; margin: 0px; color: gray !important; width: 95%;">
            <thead>
                <tr>
                    <th style="width: 25%;color: gray;">{{ _("Posted On") }}</th>
                    <th style="width: 25%;color: gray;">{{ _("Mode") }}</th>
                    <th style="width: 25%;color: gray;">{{ _("Ref Date") }}</th>
                    <th style="text-align: right;width: 25%;color: gray;">{{ _("Value") }}</th>
                </tr>
            </thead>
            <tbody>
                {% for row in pdc %}
                <tr>
                    <td style="color: gray; vertical-align: top;">{{ frappe.format(row.posting_date, 'Date') }}</td>
                    <td style="color: gray;vertical-align: top;">{{ row.mode_of_payment }}</td>
                    <td style="color: gray;vertical-align: top;">{{ frappe.format(row.reference_date, 'Date') }}</td>
                    <td style="text-align: right;color: gray;vertical-align: top;">
                        {{frappe.utils.fmt_money(row.paid_amount, currency=filters.presentation_currency) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    {% if letter_head.footer %}
		{{ letter_head.footer }}
	{% endif %}
</div>